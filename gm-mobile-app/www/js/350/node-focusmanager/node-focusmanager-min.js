YUI.add("node-focusmanager",function(g){var m={37:!0,38:!0,39:!0,40:!0},n={a:!0,button:!0,input:!0,object:!0},k=g.Lang,l=g.UA,i=function(){i.superclass.constructor.apply(this,arguments)};i.ATTRS={focused:{value:!1,readOnly:!0},descendants:{getter:function(a){return this.get("host").all(a)}},activeDescendant:{setter:function(a){var c=k.isNumber,b=g.Attribute.INVALID_VALUE,d=this._descendantsMap,e=this._descendants,f;c(a)?a=f=a:a instanceof g.Node&&d?(f=d[a.get("id")],a=c(f)?f:b):a=b;e&&(e=e.item(f))&&
e.get("disabled")&&(a=b);return a}},keys:{value:{next:null,previous:null}},focusClass:{},circular:{value:!0}};g.extend(i,g.Plugin.Base,{_stopped:!0,_descendants:null,_descendantsMap:null,_focusedNode:null,_lastNodeIndex:0,_eventHandlers:null,_initDescendants:function(){var a=this.get("descendants"),c={},b=-1,d,e=this.get("activeDescendant"),f,j,h=0;k.isUndefined(e)&&(e=-1);if(a){d=a.size();for(h=0;h<d;h++)f=a.item(h),-1===b&&!f.get("disabled")&&(b=h),0>e&&0===parseInt(f.getAttribute("tabIndex",2),
10)&&(e=h),f&&f.set("tabIndex",-1),j=f.get("id"),j||(j=g.guid(),f.set("id",j)),c[j]=h;0>e&&(e=0);f=a.item(e);if(!f||f.get("disabled"))f=a.item(b),e=b;this._lastNodeIndex=d-1;this._descendants=a;this._descendantsMap=c;this.set("activeDescendant",e);f&&f.set("tabIndex",0)}},_isDescendant:function(a){return a.get("id")in this._descendantsMap},_removeFocusClass:function(){var a=this._focusedNode,c=this.get("focusClass"),b;c&&(b=k.isString(c)?c:c.className);a&&b&&a.removeClass(b)},_detachKeyHandler:function(){var a=
this._prevKeyHandler,c=this._nextKeyHandler;a&&a.detach();c&&c.detach()},_preventScroll:function(a){m[a.keyCode]&&this._isDescendant(a.target)&&a.preventDefault()},_fireClick:function(a){var c=a.target,b=c.get("nodeName").toLowerCase();13===a.keyCode&&(!n[b]||"a"===b&&!c.getAttribute("href"))&&c.simulate("click")},_attachKeyHandler:function(){this._detachKeyHandler();var a=this.get("keys.next"),c=this.get("keys.previous"),b=this.get("host"),d=this._eventHandlers;c&&(this._prevKeyHandler=g.on("key",
g.bind(this._focusPrevious,this),b,c));a&&(this._nextKeyHandler=g.on("key",g.bind(this._focusNext,this),b,a));l.opera&&d.push(b.on("keypress",this._preventScroll,this));l.opera||d.push(b.on("keypress",this._fireClick,this))},_detachEventHandlers:function(){this._detachKeyHandler();var a=this._eventHandlers;a&&(g.Array.each(a,function(a){a.detach()}),this._eventHandlers=null)},_attachEventHandlers:function(){var a=this._descendants,c,b;a&&a.size()&&(a=this._eventHandlers||[],c=this.get("host").get("ownerDocument"),
0===a.length&&(a.push(c.on("focus",this._onDocFocus,this)),a.push(c.on("mousedown",this._onDocMouseDown,this)),a.push(this.after("keysChange",this._attachKeyHandler)),a.push(this.after("descendantsChange",this._initDescendants)),a.push(this.after("activeDescendantChange",this._afterActiveDescendantChange)),b=this.after("focusedChange",g.bind(function(a){a.newVal&&(this._attachKeyHandler(),b.detach())},this)),a.push(b)),this._eventHandlers=a)},_onDocMouseDown:function(a){var c=this.get("host"),b=a.target,
d=c.contains(b),e,f=function(a){var b=!1;a.compareTo(c)||(b=this._isDescendant(a)?a:f.call(this,a.get("parentNode")));return b};d&&((e=f.call(this,b))?b=e:!e&&this.get("focused")&&(this._set("focused",!1),this._onDocFocus(a)));if(d&&this._isDescendant(b))this.focus(b);else if(l.webkit&&this.get("focused")&&(!d||d&&!this._isDescendant(b)))this._set("focused",!1),this._onDocFocus(a)},_onDocFocus:function(a){var a=this._focusTarget||a.target,c=this.get("focused"),b=this.get("focusClass"),d=this._focusedNode,
e;this._focusTarget&&(this._focusTarget=null);this.get("host").contains(a)?(e=this._isDescendant(a),!c&&e?c=!0:c&&!e&&(c=!1)):c=!1;b&&(d&&(!d.compareTo(a)||!c)&&this._removeFocusClass(),e&&c&&(b.fn?(a=b.fn(a),a.addClass(b.className)):a.addClass(b),this._focusedNode=a));this._set("focused",c)},_focusNext:function(a,c){var b=c||this.get("activeDescendant"),d;this._isDescendant(a.target)&&b<=this._lastNodeIndex&&(b+=1,b===this._lastNodeIndex+1&&this.get("circular")&&(b=0),(d=this._descendants.item(b))&&
(d.get("disabled")?this._focusNext(a,b):this.focus(b)));this._preventScroll(a)},_focusPrevious:function(a,c){var b=c||this.get("activeDescendant"),d;this._isDescendant(a.target)&&0<=b&&(b-=1,-1===b&&this.get("circular")&&(b=this._lastNodeIndex),(d=this._descendants.item(b))&&(d.get("disabled")?this._focusPrevious(a,b):this.focus(b)));this._preventScroll(a)},_afterActiveDescendantChange:function(a){var c=this._descendants.item(a.prevVal);c&&c.set("tabIndex",-1);(c=this._descendants.item(a.newVal))&&
c.set("tabIndex",0)},initializer:function(){this.start()},destructor:function(){this.stop();this.get("host").focusManager=null},focus:function(a){k.isUndefined(a)&&(a=this.get("activeDescendant"));this.set("activeDescendant",a,{src:"UI"});if(a=this._descendants.item(this.get("activeDescendant")))a.focus(),l.opera&&"button"===a.get("nodeName").toLowerCase()&&(this._focusTarget=a)},blur:function(){var a;if(this.get("focused")){if(a=this._descendants.item(this.get("activeDescendant")))a.blur(),this._removeFocusClass();
this._set("focused",!1,{src:"UI"})}},start:function(){this._stopped&&(this._initDescendants(),this._attachEventHandlers(),this._stopped=!1)},stop:function(){this._stopped||(this._detachEventHandlers(),this._focusedNode=this._descendants=null,this._lastNodeIndex=0,this._stopped=!0)},refresh:function(){this._initDescendants();this._eventHandlers||this._attachEventHandlers()}});i.NAME="nodeFocusManager";i.NS="focusManager";g.namespace("Plugin");g.Plugin.NodeFocusManager=i},"3.5.0",{requires:"attribute,node,plugin,node-event-simulate,event-key,event-focus".split(",")});
