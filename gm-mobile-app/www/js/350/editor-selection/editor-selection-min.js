YUI.add("editor-selection",function(a){var j="textContent";a.UA.ie&&(j="nodeValue");a.EditorSelection=function(c){var b,e,d,f;a.config.win.getSelection&&(!a.UA.ie||9>a.UA.ie)?b=a.config.win.getSelection():a.config.doc.selection&&(b=a.config.doc.selection.createRange());this._selection=b;if(b.pasteHTML)if(this.isCollapsed=b.compareEndPoints("StartToEnd",b)?!1:!0){this.anchorNode=this.focusNode=a.one(b.parentElement());c&&(d=a.config.doc.elementFromPoint(c.clientX,c.clientY));c=b.duplicate();if(!d){e=
b.parentElement();e=e.childNodes;for(f=0;f<e.length;f++)c.inRange(b)&&(d||(d=e[f]))}if(this.ieNode=d){if(3!==d.nodeType&&(d.firstChild&&(d=d.firstChild),d&&d.tagName&&"body"===d.tagName.toLowerCase()&&d.firstChild))d=d.firstChild;this.anchorNode=this.focusNode=a.EditorSelection.resolve(d);c.moveToElementText(b.parentElement());e=0;b.compareEndPoints("StartToStart",c)&&(e=Math.abs(b.move("character",-9999)));this.anchorOffset=this.focusOffset=e;this.anchorTextNode=this.focusTextNode=a.one(d)}}else b.htmlText&&
""!==b.htmlText&&((d=a.Node.create(b.htmlText))&&d.get("id")?(d=d.get("id"),this.anchorNode=this.focusNode=a.one("#"+d)):d&&(d=d.get("childNodes"),this.anchorNode=this.focusNode=d.item(0)));else this.isCollapsed=b.isCollapsed,this.anchorNode=a.EditorSelection.resolve(b.anchorNode),this.focusNode=a.EditorSelection.resolve(b.focusNode),this.anchorOffset=b.anchorOffset,this.focusOffset=b.focusOffset,this.anchorTextNode=a.one(b.anchorNode),this.focusTextNode=a.one(b.focusNode);this.text=a.Lang.isString(b.text)?
b.text:b.toString?b.toString():""};a.EditorSelection.removeFontFamily=function(c){c.removeAttribute("face");var b=c.getAttribute("style").toLowerCase();(""===b||"font-family: "==b)&&c.removeAttribute("style");b.match(a.EditorSelection.REG_FONTFAMILY)&&(b=b.replace(a.EditorSelection.REG_FONTFAMILY,""),c.setAttribute("style",b))};a.EditorSelection.filter=function(c){(new Date).getTime();var b=a.all(a.EditorSelection.ALL),e=a.all("strong,em"),d=a.config.doc,f={},g="";(new Date).getTime();b.each(function(b){var c=
a.Node.getDOMNode(b);c.style.fontFamily&&(f["."+b._yuid]=c.style.fontFamily,b.addClass(b._yuid),a.EditorSelection.removeFontFamily(c))});(new Date).getTime();a.all(".hr").addClass("yui-skip").addClass("yui-non");a.UA.ie&&(b=d.getElementsByTagName("hr"),a.each(b,function(a){var b=d.createElement("div");b.className="hr yui-non yui-skip";b.setAttribute("readonly",!0);b.setAttribute("contenteditable",!1);a.parentNode&&a.parentNode.replaceChild(b,a);a=b.style;a.border="1px solid #ccc";a.lineHeight="0";
a.height="0";a.fontSize="0";a.marginTop="5px";a.marginBottom="5px";a.marginLeft="0px";a.marginRight="0px";a.padding="0"}));a.each(f,function(a,b){g=g+(b+" { font-family: "+a.replace(/"/gi,"")+"; }")});a.StyleSheet(g,"editor");e.each(function(b,c){var d="i";b.get("tagName").toLowerCase()==="strong"&&(d="b");a.EditorSelection.prototype._swap(e.item(c),d)});a.all("ol,ul").each(function(a){a.all("li").size()||a.remove()});c&&a.EditorSelection.filterBlocks();(new Date).getTime()};a.EditorSelection.filterBlocks=
function(){(new Date).getTime();var c=a.config.doc.body.childNodes,b,e,d=!1;e=!0;var f,g;if(c){for(b=0;b<c.length;b++)if(e=a.one(c[b]),e.test(a.EditorSelection.BLOCKS))d=a.EditorSelection._wrapBlock(d);else if(e=!0,3==c[b].nodeType&&(f=c[b][j].match(a.EditorSelection.REG_CHAR),g=c[b][j].match(a.EditorSelection.REG_NON),null===f&&g&&(e=!1)),e)d||(d=[]),d.push(c[b]);d=a.EditorSelection._wrapBlock(d)}b=a.all(a.EditorSelection.DEFAULT_BLOCK_TAG);if(1===b.size()){if(c=b.item(0).all("br"),1===c.size()){c.item(0).test(".yui-cursor")||
c.item(0).remove();d=b.item(0).get("innerHTML");if(""===d||" "===d)b.set("innerHTML",a.EditorSelection.CURSOR),b=new a.EditorSelection,b.focusCursor(!0,!0);c.item(0).test(".yui-cursor")&&a.UA.ie&&c.item(0).remove()}}else b.each(function(a){""===a.get("innerHTML")&&a.remove()});(new Date).getTime()};a.EditorSelection.REG_FONTFAMILY=/font-family: ;/;a.EditorSelection.REG_CHAR=/[a-zA-Z-0-9_!@#\$%\^&*\(\)-=_+\[\]\\{}|;':",.\/<>\?]/gi;a.EditorSelection.REG_NON=/[\s|\n|\t]/gi;a.EditorSelection.REG_NOHTML=
/<\S[^><]*>/g;a.EditorSelection._wrapBlock=function(c){if(c){var b=a.Node.create("<"+a.EditorSelection.DEFAULT_BLOCK_TAG+"></"+a.EditorSelection.DEFAULT_BLOCK_TAG+">"),e=a.one(c[0]),d;for(d=1;d<c.length;d++)b.append(c[d]);e.replace(b);b.prepend(e)}return!1};a.EditorSelection.unfilter=function(){var c=a.all("body [class]"),b="",e=a.one("body");c.each(function(a){a.hasClass(a._yuid)&&(a.setStyle("fontFamily",a.getStyle("fontFamily")),a.removeClass(a._yuid),""===a.getAttribute("class")&&a.removeAttribute("class"))});
a.all(".yui-non").each(function(a){!a.hasClass("yui-skip")&&""===a.get("innerHTML")?a.remove():a.removeClass("yui-non").removeClass("yui-skip")});a.all("body [id]").each(function(a){0===a.get("id").indexOf("yui_3_")&&(a.removeAttribute("id"),a.removeAttribute("_yuid"))});e&&(b=e.get("innerHTML"));a.all(".hr").addClass("yui-skip").addClass("yui-non");return b};a.EditorSelection.resolve=function(c){if(c&&3===c.nodeType)try{c=c.parentNode}catch(b){c="body"}return a.one(c)};a.EditorSelection.getText=
function(c){c=c.get("innerHTML").replace(a.EditorSelection.REG_NOHTML,"");return c=c.replace("<span><br></span>","").replace("<br>","")};a.EditorSelection.DEFAULT_BLOCK_TAG="p";a.EditorSelection.ALL="[style],font[face]";a.EditorSelection.BLOCKS="p,div,ul,ol,table,style";a.EditorSelection.TMP="yui-tmp";a.EditorSelection.DEFAULT_TAG="span";a.EditorSelection.CURID="yui-cursor";a.EditorSelection.CUR_WRAPID="yui-cursor-wrapper";a.EditorSelection.CURSOR='<span><br class="yui-cursor"></span>';a.EditorSelection.hasCursor=
function(){return a.all("#"+a.EditorSelection.CUR_WRAPID).size()};a.EditorSelection.cleanCursor=function(){var c;c=a.all("br.yui-cursor");c.size()&&c.each(function(b){var c=b.get("parentNode.parentNode.childNodes");c.size()?b.remove():(c=a.EditorSelection.getText(c.item(0)),""!==c&&b.remove())})};a.EditorSelection.prototype={text:null,isCollapsed:null,anchorNode:null,anchorOffset:null,anchorTextNode:null,focusNode:null,focusOffset:null,focusTextNode:null,_selection:null,_wrap:function(c,b){var e=
a.Node.create("<"+b+"></"+b+">");e.set("innerHTML",c.get("innerHTML"));c.set("innerHTML","");c.append(e);return a.Node.getDOMNode(e)},_swap:function(c,b){var e=a.Node.create("<"+b+"></"+b+">");e.set("innerHTML",c.get("innerHTML"));c.replace(e,c);return a.Node.getDOMNode(e)},getSelected:function(){a.EditorSelection.filter();a.config.doc.execCommand("fontname",null,a.EditorSelection.TMP);var c=a.all(a.EditorSelection.ALL),b=[];c.each(function(e,d){e.getStyle("fontFamily")==a.EditorSelection.TMP&&(e.setStyle("fontFamily",
""),a.EditorSelection.removeFontFamily(e),e.test("body")||b.push(a.Node.getDOMNode(c.item(d))))});return a.all(b)},insertContent:function(a){return this.insertAtCursor(a,this.anchorTextNode,this.anchorOffset,!0)},insertAtCursor:function(c,b,e,d){var f=a.Node.create("<"+a.EditorSelection.DEFAULT_TAG+' class="yui-non"></'+a.EditorSelection.DEFAULT_TAG+">"),g,l,h,i=this.createRange(),k;b&&b.test("body")&&(k=a.Node.create("<span></span>"),b.append(k),b=k);if(i.pasteHTML){if(0===e&&b&&!b.previous()&&3===
b.get("nodeType"))return b.insert(c,"before"),i.moveToElementText&&i.moveToElementText(a.Node.getDOMNode(b.previous())),i.collapse(!1),i.select(),b.previous();h=a.Node.create(c);try{i.pasteHTML('<span id="rte-insert"></span>')}catch(m){}if(g=a.one("#rte-insert"))return g.set("id",""),g.replace(h),i.moveToElementText&&i.moveToElementText(a.Node.getDOMNode(h)),i.collapse(!1),i.select(),h;a.on("available",function(){g.set("id","");g.replace(h);i.moveToElementText&&i.moveToElementText(a.Node.getDOMNode(h));
i.collapse(false);i.select()},"#rte-insert")}else if(0<e){if(g=b.get(j),l=a.one(a.config.doc.createTextNode(g.substr(0,e))),e=a.one(a.config.doc.createTextNode(g.substr(e))),b.replace(l,b),h=a.Node.create(c),11===h.get("nodeType")&&(k=a.Node.create("<span></span>"),k.append(h),h=k),l.insert(h,"after"),e)h.insert(f,"after"),f.insert(e,"after"),this.selectNode(f,d)}else 3===b.get("nodeType")&&(b=b.get("parentNode")),h=a.Node.create(c),c=b.get("innerHTML").replace(/\n/gi,""),""===c||"<br>"===c?b.append(h):
h.get("parentNode")?b.insert(h,"before"):a.one("body").prepend(h),b.get("firstChild").test("br")&&b.get("firstChild").remove();return h},wrapContent:function(c){c=c?c:a.EditorSelection.DEFAULT_TAG;if(this.isCollapsed)return a.all([]);var b=this.getSelected(),e=[],d,f,g;b.each(function(a,d){"font"===a.get("tagName").toLowerCase()?e.push(this._swap(b.item(d),c)):e.push(this._wrap(b.item(d),c))},this);d=this.createRange();g=e[0];f=e[e.length-1];this._selection.removeAllRanges?(d.setStart(e[0],0),d.setEnd(f,
f.childNodes.length),this._selection.removeAllRanges(),this._selection.addRange(d)):(d.moveToElementText&&(d.moveToElementText(a.Node.getDOMNode(g)),g=this.createRange(),g.moveToElementText(a.Node.getDOMNode(f)),d.setEndPoint("EndToEnd",g)),d.select());return e=a.all(e)},replace:function(c,b){var e=this.createRange(),d,f;e.getBookmark?(f=e.getBookmark(),d=this.anchorNode.get("innerHTML").replace(c,b),this.anchorNode.set("innerHTML",d),e.moveToBookmark(f),d=a.one(e.parentElement())):(e=this.anchorTextNode,
d=e.get(j),f=d.indexOf(c),d=d.replace(c,""),e.set(j,d),d=this.insertAtCursor(b,e,f,!0));return d},remove:function(){this._selection&&this._selection.removeAllRanges&&this._selection.removeAllRanges();return this},createRange:function(){return a.config.doc.selection?a.config.doc.selection.createRange():a.config.doc.createRange()},selectNode:function(c,b,e){if(c){var e=e||0,c=a.Node.getDOMNode(c),d=this.createRange();if(d.selectNode){if(d.selectNode(c),this._selection.removeAllRanges(),this._selection.addRange(d),
b)try{this._selection.collapse(c,e)}catch(f){this._selection.collapse(c,0)}}else{3===c.nodeType&&(c=c.parentNode);try{d.moveToElementText(c)}catch(g){}b&&d.collapse(e?!1:!0);d.select()}return this}},setCursor:function(){this.removeCursor(!1);return this.insertContent(a.EditorSelection.CURSOR)},getCursor:function(){return a.all("#"+a.EditorSelection.CURID)},removeCursor:function(a){var b=this.getCursor();b&&(a?(b.removeAttribute("id"),b.set("innerHTML",'<br class="yui-cursor">')):b.remove());return b},
focusCursor:function(a,b){!1!==a&&(a=!0);!1!==b&&(b=!0);var e=this.removeCursor(!0);e&&e.each(function(d){this.selectNode(d,a,b)},this)},toString:function(){return"EditorSelection Object"}};a.Selection=a.EditorSelection},"3.5.0",{skinnable:!1,requires:["node"]});
