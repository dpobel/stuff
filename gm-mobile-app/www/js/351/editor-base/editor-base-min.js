YUI.add("editor-base",function(d){var f=function(){f.superclass.constructor.apply(this,arguments)};d.extend(f,d.Base,{frame:null,initializer:function(){var a=(new d.Frame({designMode:!0,title:f.STRINGS.title,use:f.USE,dir:this.get("dir"),extracss:this.get("extracss"),linkedcss:this.get("linkedcss"),defaultblock:this.get("defaultblock"),host:this})).plug(d.Plugin.ExecCommand);a.after("ready",d.bind(this._afterFrameReady,this));a.addTarget(this);this.frame=a;this.publish("nodeChange",{emitFacade:!0,
bubbles:!0,defaultFn:this._defNodeChangeFn})},destructor:function(){this.frame.destroy();this.detachAll()},copyStyles:function(a,b){if(!a.test("a")){var c={};d.each(["color","fontSize","fontFamily","backgroundColor","fontStyle"],function(b){c[b]=a.getStyle(b)});a.ancestor("b,strong")&&(c.fontWeight="bold");a.ancestor("u")&&!c.textDecoration&&(c.textDecoration="underline");b.setStyles(c)}},_lastBookmark:null,_resolveChangedNode:function(a){var b=this.getInstance(),c,d,e;if(a&&a.test("body")&&(c=new b.EditorSelection)&&
c.anchorNode)a=c.anchorNode;if(b&&a&&a.test("html")){for(c=b.one("body").one(":last-child");!e;)c?(d=c.one(":last-child"))?c=d:e=!0:e=!0;c&&(c.test("br")&&(c=c.previous()?c.previous():c.get("parentNode")),c&&(a=c))}a||(a=b.one("body"));return a},_defNodeChangeFn:function(a){(new Date).getTime();var b=this.getInstance(),c;if(d.UA.ie)try{c=b.config.doc.selection.createRange(),c.getBookmark&&(this._lastBookmark=c.getBookmark())}catch(g){}a.changedNode=this._resolveChangedNode(a.changedNode);switch(a.changedType){case "tab":!a.changedNode.test("li, li *")&&
!a.changedEvent.shiftKey&&(a.changedEvent.frameEvent.preventDefault(),d.UA.webkit?this.execCommand("inserttext","\t"):d.UA.gecko?this.frame.exec._command("inserthtml",f.TABKEY):d.UA.ie&&this.execCommand("inserthtml",f.TABKEY));break;case "backspace-up":d.UA.webkit&&a.changedNode&&a.changedNode.set("innerHTML",a.changedNode.get("innerHTML"))}if(d.UA.webkit&&a.commands&&(a.commands.indent||a.commands.outdent))c=b.all(".webkit-indent-blockquote"),c.size()&&c.setStyle("margin","");c=this.getDomPath(a.changedNode,
!1);var e={},h,i,j=[],k="",l="";a.commands&&(e=a.commands);var m=!1;d.each(c,function(a){var c=a.tagName.toLowerCase();(c=f.TAG2CMD[c])&&(e[c]=1);c=a.currentStyle||a.style;""+c.fontWeight=="normal"&&(m=true);if(""+c.fontWeight=="bold")e.bold=1;if(d.UA.ie&&c.fontWeight>400)e.bold=1;if(c.fontStyle=="italic")e.italic=1;if(c.textDecoration=="underline")e.underline=1;if(c.textDecoration=="line-through")e.strikethrough=1;var g=b.one(a);if(g.getStyle("fontFamily")){var n=g.getStyle("fontFamily").split(",")[0].toLowerCase();
n&&(h=n);h&&(h=h.replace(/'/g,"").replace(/"/g,""))}i=f.NORMALIZE_FONTSIZE(g);a=a.className.split(" ");d.each(a,function(a){a!==""&&a.substr(0,4)!=="yui_"&&j.push(a)});k=f.FILTER_RGB(g.getStyle("color"));a=f.FILTER_RGB(c.backgroundColor);a!=="transparent"&&a!==""&&(l=a)});m&&(delete e.bold,delete e.italic);a.dompath=b.all(c);a.classNames=j;a.commands=e;a.fontFamily||(a.fontFamily=h);a.fontSize||(a.fontSize=i);a.fontColor||(a.fontColor=k);a.backgroundColor||(a.backgroundColor=l);(new Date).getTime()},
getDomPath:function(a,b){var c=[],d,e=this.frame.getInstance();for(d=e.Node.getDOMNode(a);null!==d&&!(d===e.config.doc.documentElement||d===e.config.doc||!d.tagName)&&e.DOM.inDoc(d);){d.nodeName&&d.nodeType&&1==d.nodeType&&c.push(d);if(d==e.config.doc.body)break;d=d.parentNode}0===c.length&&(c[0]=e.config.doc.body);return b?e.all(c.reverse()):c.reverse()},_afterFrameReady:function(){var a=this.frame.getInstance();this.frame.on("dom:mouseup",d.bind(this._onFrameMouseUp,this));this.frame.on("dom:mousedown",
d.bind(this._onFrameMouseDown,this));this.frame.on("dom:keydown",d.bind(this._onFrameKeyDown,this));d.UA.ie&&(this.frame.on("dom:activate",d.bind(this._onFrameActivate,this)),this.frame.on("dom:beforedeactivate",d.bind(this._beforeFrameDeactivate,this)));this.frame.on("dom:keyup",d.bind(this._onFrameKeyUp,this));this.frame.on("dom:keypress",d.bind(this._onFrameKeyPress,this));this.frame.on("dom:paste",d.bind(this._onPaste,this));a.EditorSelection.filter();this.fire("ready")},_beforeFrameDeactivate:function(a){a.frameTarget.test("html")||
(a=this.getInstance().config.doc.selection.createRange(),a.compareEndPoints&&!a.compareEndPoints("StartToEnd",a)&&a.pasteHTML('<var id="yui-ie-cursor">'))},_onFrameActivate:function(a){if(!a.frameTarget.test("html")){var a=this.getInstance(),b=(new a.EditorSelection).createRange(),a=a.all("#yui-ie-cursor");a.size()&&a.each(function(a){a.set("id","");if(b.moveToElementText)try{b.moveToElementText(a._node),-1===b.move("character",-1)&&b.move("character",1),b.select(),b.text=""}catch(d){}a.remove()})}},
_onPaste:function(a){this.fire("nodeChange",{changedNode:a.frameTarget,changedType:"paste",changedEvent:a.frameEvent})},_onFrameMouseUp:function(a){this.fire("nodeChange",{changedNode:a.frameTarget,changedType:"mouseup",changedEvent:a.frameEvent})},_onFrameMouseDown:function(a){this.fire("nodeChange",{changedNode:a.frameTarget,changedType:"mousedown",changedEvent:a.frameEvent})},_currentSelection:null,_currentSelectionTimer:null,_currentSelectionClear:null,_onFrameKeyDown:function(a){var b;this._currentSelection?
b=this._currentSelection:(this._currentSelectionTimer&&this._currentSelectionTimer.cancel(),this._currentSelectionTimer=d.later(850,this,function(){this._currentSelectionClear=!0}),b=this.frame.getInstance(),this._currentSelection=b=new b.EditorSelection(a));b=this.frame.getInstance();if((this._currentSelection=b=new b.EditorSelection)&&b.anchorNode)this.fire("nodeChange",{changedNode:b.anchorNode,changedType:"keydown",changedEvent:a.frameEvent}),f.NC_KEYS[a.keyCode]&&(this.fire("nodeChange",{changedNode:b.anchorNode,
changedType:f.NC_KEYS[a.keyCode],changedEvent:a.frameEvent}),this.fire("nodeChange",{changedNode:b.anchorNode,changedType:f.NC_KEYS[a.keyCode]+"-down",changedEvent:a.frameEvent}))},_onFrameKeyPress:function(a){var b=this._currentSelection;b&&b.anchorNode&&(this.fire("nodeChange",{changedNode:b.anchorNode,changedType:"keypress",changedEvent:a.frameEvent}),f.NC_KEYS[a.keyCode]&&this.fire("nodeChange",{changedNode:b.anchorNode,changedType:f.NC_KEYS[a.keyCode]+"-press",changedEvent:a.frameEvent}))},_onFrameKeyUp:function(a){var b=
new (this.frame.getInstance().EditorSelection)(a);b&&b.anchorNode&&(this.fire("nodeChange",{changedNode:b.anchorNode,changedType:"keyup",selection:b,changedEvent:a.frameEvent}),f.NC_KEYS[a.keyCode]&&this.fire("nodeChange",{changedNode:b.anchorNode,changedType:f.NC_KEYS[a.keyCode]+"-up",selection:b,changedEvent:a.frameEvent}));this._currentSelectionClear&&(this._currentSelectionClear=this._currentSelection=null)},execCommand:function(a,b){var c=this.frame.execCommand(a,b),d={},e={changedNode:(new (this.frame.getInstance().EditorSelection)).anchorNode,
changedType:"execcommand",nodes:c};switch(a){case "forecolor":e.fontColor=b;break;case "backcolor":e.backgroundColor=b;break;case "fontsize":e.fontSize=b;break;case "fontname":e.fontFamily=b}d[a]=1;e.commands=d;this.fire("nodeChange",e);return c},getInstance:function(){return this.frame.getInstance()},render:function(a){this.frame.set("content",this.get("content"));this.frame.render(a);return this},focus:function(a){this.frame.focus(a);return this},show:function(){this.frame.show();return this},hide:function(){this.frame.hide();
return this},getContent:function(){var a="",b=this.getInstance();b&&b.EditorSelection&&(a=b.EditorSelection.unfilter());return a=a.replace(/ _yuid="([^>]*)"/g,"")}},{NORMALIZE_FONTSIZE:function(a){var b=a.getStyle("fontSize"),c=b;switch(b){case "-webkit-xxx-large":b="48px";break;case "xx-large":b="32px";break;case "x-large":b="24px";break;case "large":b="18px";break;case "medium":b="16px";break;case "small":b="13px";break;case "x-small":b="10px"}c!==b&&a.setStyle("fontSize",b);return b},TABKEY:'<span class="tab">&nbsp;&nbsp;&nbsp;&nbsp;</span>',
FILTER_RGB:function(a){if(-1!=a.toLowerCase().indexOf("rgb")){var b=a.replace(RegExp("(.*?)rgb\\s*?\\(\\s*?([0-9]+).*?,\\s*?([0-9]+).*?,\\s*?([0-9]+).*?\\)(.*?)","gi"),"$1,$2,$3,$4,$5").split(",");if(5==b.length)var a=parseInt(b[1],10).toString(16),c=parseInt(b[2],10).toString(16),b=parseInt(b[3],10).toString(16),a=1==a.length?"0"+a:a,c=1==c.length?"0"+c:c,b=1==b.length?"0"+b:b,a="#"+a+c+b}return a},TAG2CMD:{b:"bold",strong:"bold",i:"italic",em:"italic",u:"underline",sup:"superscript",sub:"subscript",
img:"insertimage",a:"createlink",ul:"insertunorderedlist",ol:"insertorderedlist"},NC_KEYS:{8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",46:"delete"},USE:["substitute","node","selector-css3","editor-selection","stylesheet"],NAME:"editorBase",STRINGS:{title:"Rich Text Editor"},ATTRS:{content:{value:'<br class="yui-cursor">',setter:function(a){"\n"===a.substr(0,1)&&(a=a.substr(1));""===a&&(a='<br class="yui-cursor">');
" "===a&&d.UA.gecko&&(a='<br class="yui-cursor">');return this.frame.set("content",a)},getter:function(){return this.frame.get("content")}},dir:{writeOnce:!0,value:"ltr"},linkedcss:{value:"",setter:function(a){this.frame&&this.frame.set("linkedcss",a);return a}},extracss:{value:!1,setter:function(a){this.frame&&this.frame.set("extracss",a);return a}},defaultblock:{value:"p"}}});d.EditorBase=f},"3.5.1",{skinnable:!1,requires:["base","frame","node","exec-command","editor-selection"]});
