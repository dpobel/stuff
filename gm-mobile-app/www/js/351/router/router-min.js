YUI.add("router",function(c){function l(){l.superclass.constructor.apply(this,arguments)}var h=c.HistoryHash,j=c.QueryString,k=c.Array,m=c.config.win,n=[];c.Router=c.extend(l,c.Base,{_regexPathParam:/([:*])([\w\-]+)?/g,_regexUrlQuery:/\?([^#]*).*$/,_regexUrlOrigin:/^(?:[^\/#?:]+:\/\/|\/\/)[^\/]*/,initializer:function(a){var b=this;b._html5=b.get("html5");b._routes=[];b._url=b._getURL();b._setRoutes(a&&a.routes?a.routes:b.get("routes"));if(b._html5)b._history=new c.HistoryHTML5({force:!0}),c.after("history:change",
b._afterHistoryChange,b);else c.on("hashchange",b._afterHistoryChange,m,b);b.publish("ready",{defaultFn:b._defReadyFn,fireOnce:!0,preventable:!1});b.once("initializedChange",function(){c.once("load",function(){setTimeout(function(){b.fire("ready",{dispatched:!!b._dispatched})},20)})})},destructor:function(){this._html5?c.detach("history:change",this._afterHistoryChange,this):c.detach("hashchange",this._afterHistoryChange,m)},dispatch:function(){this.once("ready",function(){this._ready=!0;(!this._html5||
!this.upgrade())&&this._dispatch(this._getPath(),this._getURL())});return this},getPath:function(){return this._getPath()},hasRoute:function(a){if(!this._hasSameOrigin(a))return!1;a=this.removeQuery(this.removeRoot(a));return!!this.match(a).length},match:function(a){return k.filter(this._routes,function(b){return-1<a.search(b.regex)})},removeRoot:function(a){var b=this.get("root"),a=a.replace(this._regexUrlOrigin,"");b&&0===a.indexOf(b)&&(a=a.substring(b.length));return"/"===a.charAt(0)?a:"/"+a},
removeQuery:function(a){return a.replace(/\?.*$/,"")},replace:function(a){return this._queue(a,!0)},route:function(a,b){var c=[];this._routes.push({callback:b,keys:c,path:a,regex:this._getRegex(a,c)});return this},save:function(a){return this._queue(a)},upgrade:function(){if(!this._html5)return!1;var a=h.getHash();return a&&"/"===a.charAt(0)?(this.once("ready",function(){this.replace(a)}),!0):!1},_decode:function(a){return decodeURIComponent(a.replace(/\+/g," "))},_dequeue:function(){var a=this,b;
return!YUI.Env.windowLoaded?(c.once("load",function(){a._dequeue()}),this):(b=n.shift())?b():this},_dispatch:function(a,b,d){var e=this,g=e.match(a),f,h;e._dispatching=e._dispatched=!0;if(!g||!g.length)return e._dispatching=!1,e;f=e._getRequest(a,b,d);h=e._getResponse(f);f.next=function(b){var d,i;if(b)c.error(b);else if(i=g.shift())d=i.regex.exec(a),b="string"===typeof i.callback?e[i.callback]:i.callback,f.params=d.length===i.keys.length+1?k.hash(i.keys,d.slice(1)):d.concat(),b.call(e,f,h,f.next)};
f.next();e._dispatching=!1;return e._dequeue()},_getHashPath:function(){return h.getHash().replace(this._regexUrlQuery,"")},_getOrigin:function(){var a=c.getLocation();return a.origin||a.protocol+"//"+a.host},_getPath:function(){return this.removeQuery(this.removeRoot(!this._html5&&this._getHashPath()||c.getLocation().pathname))},_getQuery:function(){var a=c.getLocation(),b,d;if(this._html5)return a.search.substring(1);b=h.getHash();d=b.match(this._regexUrlQuery);return b&&d?d[1]:a.search.substring(1)},
_getRegex:function(a,b){if(a instanceof RegExp)return a;if("*"===a)return/.*/;a=a.replace(this._regexPathParam,function(a,c,g){if(!g)return"*"===c?".*":a;b.push(g);return"*"===c?"(.*?)":"([^/#?]*)"});return RegExp("^"+a+"$")},_getRequest:function(a,b,c){return{path:a,query:this._parseQuery(this._getQuery()),url:b,src:c}},_getResponse:function(a){var b=function(){return a.next.apply(this,arguments)};b.req=a;return b},_getRoutes:function(){return this._routes.concat()},_getURL:function(){return c.getLocation().toString()},
_hasSameOrigin:function(a){(a=(a&&a.match(this._regexUrlOrigin)||[])[0])&&0===a.indexOf("//")&&(a=c.getLocation().protocol+a);return!a||a===this._getOrigin()},_joinURL:function(a){var b=this.get("root"),a=this.removeRoot(a);"/"===a.charAt(0)&&(a=a.substring(1));return b&&"/"===b.charAt(b.length-1)?b+a:b+"/"+a},_parseQuery:j&&j.parse?j.parse:function(a){for(var b=this._decode,a=a.split("&"),c=0,e=a.length,g={},f;c<e;++c)f=a[c].split("="),f[0]&&(g[b(f[0])]=b(f[1]||""));return g},_queue:function(){var a=
arguments,b=this;n.push(function(){b._html5?c.UA.ios&&5>c.UA.ios?b._save.apply(b,a):setTimeout(function(){b._save.apply(b,a)},1):(b._dispatching=!0,b._save.apply(b,a));return b});return!this._dispatching?this._dequeue():this},_save:function(a,b){var d="string"===typeof a;if(d&&!this._hasSameOrigin(a))return c.error("Security error: The new URL must be of the same origin as the current URL."),this;this._ready=!0;if(this._html5)this._history[b?"replace":"add"](null,{url:d?this._joinURL(a):a});else if(d&&
(a=this.removeRoot(a)),a===h.getHash())this._dispatch(this._getPath(),this._getURL());else h[b?"replaceHash":"setHash"](a);return this},_setRoutes:function(a){this._routes=[];k.each(a,function(a){this.route(a.path,a.callback)},this);return this._routes.concat()},_afterHistoryChange:function(a){var a=a.src,b=this._url,c=this._getURL();this._url=c;"popstate"===a&&(!this._ready||b.replace(/#.*$/,"")===c.replace(/#.*$/,""))||this._dispatch(this._getPath(),c,a)},_defReadyFn:function(){this._ready=!0}},
{NAME:"router",ATTRS:{html5:{valueFn:function(){return c.Router.html5},writeOnce:"initOnly"},root:{value:""},routes:{value:[],getter:"_getRoutes",setter:"_setRoutes"}},html5:c.HistoryBase.html5&&(!c.UA.android||3<=c.UA.android)});c.Controller=c.Router},"3.5.1",{requires:["array-extras","base-build","history"],optional:["querystring-parse"]});
