YUI.add("uploader-queue",function(d){var c=function(a){this.queuedFiles=[];this.numberOfUploads=0;this.currentUploadedByteValues={};this.currentFiles={};this.totalBytes=this.totalBytesUploaded=0;c.superclass.constructor.apply(this,arguments)};d.extend(c,d.Base,{_currentState:c.STOPPED,initializer:function(){},_uploadStartHandler:function(a){a.file=a.target;a.originEvent=a;this.fire("uploadstart",a)},_uploadErrorHandler:function(a){var b=this.get("errorAction");a.file=a.target;a.originEvent=a;this.numberOfUploads-=
1;delete this.currentFiles[a.target.get("id")];a.target.cancelUpload();b===c.STOP?this.pauseUpload():b===c.RESTART_ASAP?(this.queuedFiles.unshift(a.target),this._startNextFile()):b===c.RESTART_AFTER&&(this.queuedFiles.push(a.target),this._startNextFile());this.fire("uploaderror",a)},_startNextFile:function(){if(0<this.queuedFiles.length){var a=this.queuedFiles.shift(),b=a.get("id"),c=this.get("perFileParameters"),c=c.hasOwnProperty(b)?c[b]:c;this.currentUploadedByteValues[b]=0;a.on("uploadstart",
this._uploadStartHandler,this);a.on("uploadprogress",this._uploadProgressHandler,this);a.on("uploadcomplete",this._uploadCompleteHandler,this);a.on("uploaderror",this._uploadErrorHandler,this);a.startUpload(this.get("uploadURL"),c,this.get("fileFieldName"));this._registerUpload(a)}},_registerUpload:function(a){this.numberOfUploads+=1;this.currentFiles[a.get("id")]=a},_unregisterUpload:function(a){0<this.numberOfUploads&&(this.numberOfUploads-=1);delete this.currentFiles[a.get("id")]},_uploadCompleteHandler:function(a){this._unregisterUpload(a.target);
this.totalBytesUploaded+=a.target.get("size");delete this.currentUploadedByteValues[a.target.get("id")];0<this.queuedFiles.length&&this._currentState===c.UPLOADING&&this._startNextFile();a.file=a.target;a.originEvent=a;var b=this.totalBytesUploaded;d.each(this.currentUploadedByteValues,function(a){b+=a});var e=Math.min(100,Math.round(1E4*b/this.totalBytes)/100);this.fire("totaluploadprogress",{bytesLoaded:b,bytesTotal:this.totalBytes,percentLoaded:e});this.fire("uploadcomplete",a);0===this.queuedFiles.length&&
0>=this.numberOfUploads&&(this.fire("alluploadscomplete"),this._currentState=c.STOPPED)},_uploadProgressHandler:function(a){this.currentUploadedByteValues[a.target.get("id")]=a.bytesLoaded;a.originEvent=a;a.file=a.target;this.fire("uploadprogress",a);var b=this.totalBytesUploaded;d.each(this.currentUploadedByteValues,function(a){b+=a});a=Math.min(100,Math.round(1E4*b/this.totalBytes)/100);this.fire("totaluploadprogress",{bytesLoaded:b,bytesTotal:this.totalBytes,percentLoaded:a})},startUpload:function(){this.queuedFiles=
this.get("fileList").slice(0);this.numberOfUploads=0;this.currentUploadedByteValues={};this.currentFiles={};this.totalBytesUploaded=0;for(this._currentState=c.UPLOADING;this.numberOfUploads<this.get("simUploads")&&0<this.queuedFiles.length;)this._startNextFile()},pauseUpload:function(){this._currentState=c.STOPPED},restartUpload:function(){for(this._currentState=c.UPLOADING;this.numberOfUploads<this.get("simUploads");)this._startNextFile()},forceReupload:function(a){this.currentFiles.hasOwnProperty(a.get("id"))&&
(a.cancelUpload(),this._unregisterUpload(a),this.queuedFiles.unshift(a),this._startNextFile())},addToQueueTop:function(a){this.queuedFiles.unshift(a)},addToQueueBottom:function(a){this.queuedFiles.push(a)},cancelUpload:function(a){if(a)if(a=a.get("id"),this.currentFiles[a])this.currentFiles[a].cancelUpload(),this._unregisterUpload(this.currentFiles[a]);else for(var b=0,d=this.queuedFiles.length;b<d;b++){if(this.queuedFiles[b].get("id")===a){this.queuedFiles.splice(b,1);break}}else{for(b in this.currentFiles)this.currentFiles[b].cancelUpload(),
this._unregisterUpload(this.currentFiles[b]);this.currentUploadedByteValues={};this.currentFiles={};this.totalBytesUploaded=0;this.fire("alluploadscancelled");this._currentState=c.STOPPED}}},{CONTINUE:"continue",STOP:"stop",RESTART_ASAP:"restartasap",RESTART_AFTER:"restartafter",STOPPED:"stopped",UPLOADING:"uploading",NAME:"uploaderqueue",ATTRS:{simUploads:{value:2,validator:function(a){return 1<=a&&5>=a}},errorAction:{value:"continue",validator:function(a){return a===c.CONTINUE||a===c.STOP||a===
c.RESTART_ASAP||a===c.RESTART_AFTER}},bytesUploaded:{readOnly:!0,value:0},bytesTotal:{readOnly:!0,value:0},fileList:{value:[],lazyAdd:!1,setter:function(a){d.Array.each(a,function(a){this.totalBytes+=a.get("size")},this);return a}},fileFieldName:{value:"Filedata"},uploadURL:{value:""},perFileParameters:{value:{}}}});d.namespace("Uploader");d.Uploader.Queue=c},"3.5.1",{requires:["base"]});
